import React, { useState, useEffect, useRef } from "react";
import { useLocation } from "react-router-dom";
import { jsPDF } from "jspdf";
import { logoBase64 } from "./logo";

/* =========================================
   CONSTANTS & REGULATORY DATA
========================================= */
const ONTARIO_GUIDELINE_2025 = 2.5;

const UI = {
  en: {
    title: "CAPtenant Letter Generator",
    labelInput: "Draft your letter or review imported notes:",
    labelTone: "Tone:",
    btnRewrite: "Generate / Rewrite Letter",
    placeholder: "Type your notes here...",
    working: "CAPtenant is generating your letter...",
    subject: "Subject",
    signature: "Tenant Signature",
    rightsTip: "Helpful information:",
    fromVoice: "Generated from Voice Assistant",
    fromAgi: "Generated from AGI Explainer",
    agiWarning:
      "‚ö†Ô∏è Notice: The increase described exceeds Ontario‚Äôs annual guideline.",
    download: "Download PDF",
    refsTitle: "Relevant Ontario Rental Rules (Informational)",
    refsIntro:
      "The following high-level references may help you better understand your rights and options under Ontario law:"
  },
  fr: {
    title: "G√©n√©rateur de lettres CAPtenant",
    labelInput:
      "R√©digez votre lettre ou r√©visez les notes import√©es :",
    labelTone: "Ton :",
    btnRewrite: "G√©n√©rer / R√©√©crire la lettre",
    placeholder: "Tapez vos notes ici...",
    working: "CAPtenant g√©n√®re votre lettre...",
    subject: "Objet",
    signature: "Signature du locataire",
    rightsTip: "Information utile :",
    fromVoice: "G√©n√©r√© par l‚Äôassistant vocal",
    fromAgi: "G√©n√©r√© par l‚Äôoutil AGI",
    agiWarning:
      "‚ö†Ô∏è Avis : l‚Äôaugmentation d√©crite d√©passe la ligne directrice annuelle.",
    download: "T√©l√©charger le PDF",
    refsTitle: "R√®gles locatives pertinentes en Ontario (information)",
    refsIntro:
      "Les r√©f√©rences suivantes peuvent vous aider √† mieux comprendre vos droits et options selon la loi ontarienne :"
  }
};

/* =========================
   üîå BACKEND
========================= */
const API_BASE =
  import.meta.env.VITE_API_URL ??
  "https://captenant-production.up.railway.app";

export default function LetterGenerator() {
  const location = useLocation();
  const params = new URLSearchParams(location.search);

  /* üá®üá¶ Language lock */
  const rawLang = params.get("lang") || "en";
  const isFrench = rawLang.toLowerCase().startsWith("fr");
  const lang = isFrench ? "fr" : "en";
  const t = UI[lang];
  const letterLanguage = isFrench ? "fr-CA" : "en-CA";

  /* --- STATE --- */
  const [inputText, setInputText] = useState("");
  const [style, setStyle] = useState("professional");
  const [rewritten, setRewritten] = useState("");
  const [subjectLine, setSubjectLine] = useState("");
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState("");
  const [isAboveGuideline, setIsAboveGuideline] = useState(false);
  const [aboveGuidelinePercent, setAboveGuidelinePercent] = useState(null);

  const autoGeneratedRef = useRef(false);
  const fromSource = params.get("from");
  const incomingIntent = (params.get("intent") || "").toLowerCase();

  /* =========================================
      INIT FROM QUERY (VOICE / AGI)
  ========================================= */
  useEffect(() => {
    const agi = Number(params.get("agiPercent"));
    if (agi > ONTARIO_GUIDELINE_2025) {
      setIsAboveGuideline(true);
      setAboveGuidelinePercent(
        (agi - ONTARIO_GUIDELINE_2025).toFixed(2)
      );
    }

    const summary =
      params.get("summary") || params.get("agiSummary") || "";
    const tone = params.get("agiTone") || "professional";

    if (summary && !inputText) {
      setInputText(summary);
      setStyle(tone);
    }

    if (summary && !autoGeneratedRef.current) {
      autoGeneratedRef.current = true;
      callRewriteAPI(summary, tone);
    }
  }, [location.search]);

  /* =========================================
      HELPFUL INFO TIP (SAFE)
  ========================================= */
  const getRightsTip = () => {
    const lower = inputText.toLowerCase();
    const raw = inputText || "";

    if (
      lower.includes("n12") ||
      lower.includes("own use") ||
      raw.includes("ÿ•ÿÆŸÑÿßÿ°") ||
      /\bnikal(na)?\b/i.test(raw)
    ) {
      return lang === "fr"
        ? "Dans certains cas, une compensation √©quivalente √† un mois de loyer peut √™tre requise."
        : "In some cases, compensation equal to one month‚Äôs rent may be required.";
    }

    if (
      lower.includes("deposit") ||
      raw.includes("ŸàÿØŸäÿπÿ©") ||
      lower.includes("paise")
    ) {
      return lang === "fr"
        ? "Les d√©p√¥ts pour dommages ou animaux ne sont g√©n√©ralement pas permis."
        : "Damage and pet deposits are generally not permitted.";
    }

    return null;
  };

  /* =========================================
      SUBJECT LINE
  ========================================= */
  const generateTitle = () => {
    if (incomingIntent.includes("evict"))
      return lang === "fr"
        ? "Objet : Contestation d‚Äôexpulsion"
        : "Subject: Eviction Concern";

    if (incomingIntent.includes("repair"))
      return lang === "fr"
        ? "Objet : Demande de r√©parations"
        : "Subject: Request for Repairs";

    return lang === "fr"
      ? "Objet : Communication du locataire"
      : "Subject: Tenant Communication";
  };

  /* =========================================
      AI REWRITE ‚Äî LETTER CONTENT ONLY
  ========================================= */
  const callRewriteAPI = async (
    textToProcess,
    selectedStyle
  ) => {
    const finalInput = textToProcess || inputText;
    if (!finalInput.trim()) return;

    setLoading(true);
    setErrorMsg("");

    const baseInstruction =
      lang === "fr"
        ? "R√©dige la lettre enti√®rement en fran√ßais canadien (fr-CA)."
        : "Write the letter entirely in Canadian English (en-CA).";

    try {
      const res = await fetch(`${API_BASE}/rewrite`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: `${baseInstruction}\n\n${finalInput}`,
          style: selectedStyle || style,
          language: letterLanguage
        })
      });

      if (!res.ok) throw new Error();
      const data = await res.json();

      setRewritten((data.rewritten || "").trim());
      setSubjectLine(generateTitle());
    } catch {
      setErrorMsg(
        lang === "fr"
          ? "Impossible de joindre le service CAPtenant."
          : "Unable to reach CAPtenant service."
      );
    } finally {
      setLoading(false);
    }
  };

  /* =========================================
      INFORMATIONAL REFERENCES (SAFE)
  ========================================= */
  const renderInfoRefs = () => {
    const raw = inputText || "";
const isEviction =
  incomingIntent.includes("evict") ||
  raw.includes("ÿ•ÿÆŸÑÿßÿ°") ||
  /\bnikal(na)?\b/i.test(raw) ||
  /sans pr√©avis|without notice/i.test(raw);

const isRentIncrease =
  incomingIntent.includes("rent") ||
  incomingIntent.includes("increase") ||
  raw.includes("%") ||
  /increase|rent|augmentation|loyer|hausse/i.test(raw);

const shouldShowRefs = isEviction || isRentIncrease;
if (!shouldShowRefs) return null;

    return (
      <div
        style={{
          marginTop: "2rem",
          padding: "1.2rem",
          background: "#f1f3f5",
          borderLeft: "5px solid #0d6efd",
          borderRadius: "6px",
          fontSize: "0.95rem"
        }}
      >
        <strong>{t.refsTitle}</strong>
        <p style={{ marginTop: "0.5rem" }}>{t.refsIntro}</p>

<ul style={{ marginTop: "0.5rem" }}>
  {lang === "fr" ? (
    <>
      <li>
        Les expulsions n√©cessitent g√©n√©ralement un avis valide et une proc√©dure
        l√©gale devant le Tribunal de la location immobili√®re.
      </li>
      <li>
        Les expulsions sans ordonnance du Tribunal sont g√©n√©ralement interdites.
      </li>
      <li>
        Certains avis (par exemple pour usage personnel) peuvent entra√Æner une
        obligation d‚Äôindemnisation.
      </li>
      <li>
        Le Tribunal dispose d‚Äôun pouvoir discr√©tionnaire lors de l‚Äôanalyse des
        preuves et de la d√©cision finale.
      </li>
    </>
  ) : (
    <>
      <li>
        Evictions generally require proper notice and legal process through the
        Landlord and Tenant Board.
      </li>
      <li>
        Lockouts without an order from the Board are typically prohibited.
      </li>
      <li>
        Certain notices (such as own-use notices) may trigger compensation
        obligations.
      </li>
      <li>
        The Board has discretion when reviewing evidence and determining
        outcomes.
      </li>
    </>
  )}
</ul>

        <div style={{ marginTop: "0.75rem", fontSize: "0.9rem" }}>
          <div>
            üìò Ontario Residential Tenancies Act:
            <br />
            <a
              href="https://www.ontario.ca/laws/statute/06r17"
              target="_blank"
              rel="noreferrer"
            >
              https://www.ontario.ca/laws/statute/06r17
            </a>
          </div>

          <div style={{ marginTop: "0.5rem" }}>
            ‚öñÔ∏è Tribunals Ontario ‚Äî Landlord and Tenant Board:
            <br />
            <a
              href="https://tribunalsontario.ca/ltb/"
              target="_blank"
              rel="noreferrer"
            >
              https://tribunalsontario.ca/ltb/
            </a>
          </div>
        </div>
      </div>
    );
  };

  /* =========================================
      PDF GENERATION (UNCHANGED STRUCTURE)
  ========================================= */
  const downloadAsPDF = () => {
    if (!rewritten) return;

    try {
      const doc = new jsPDF();
      let y = 20;

      if (logoBase64 && logoBase64.startsWith("data:image")) {
        try {
          doc.addImage(logoBase64, "PNG", 15, y, 30, 30);
          y += 40;
        } catch {
          y += 10;
        }
      }

      doc.setFontSize(12);
      doc.setFont("helvetica", "bold");
      doc.text(subjectLine || "Communication", 15, y);
      y += 12;

      doc.setFontSize(11);
      doc.setFont("helvetica", "normal");
      const lines = doc.splitTextToSize(rewritten, 180);

      lines.forEach((line) => {
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
        doc.text(line, 15, y);
        y += 7;
      });

      y += 15;
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      doc.text("______________________________", 15, y);
      y += 7;
      doc.setFont("helvetica", "italic");
      doc.text(t.signature, 15, y);

      doc.save(`CAPtenant_Letter_${Date.now()}.pdf`);
    } catch {
      alert(
        lang === "fr"
          ? "Erreur lors de la cr√©ation du PDF."
          : "Error creating PDF."
      );
    }
  };

  /* =========================================
      RENDER
  ========================================= */
  return (
    <div style={{ padding: "2rem", maxWidth: "900px", margin: "auto" }}>
      <h1>{t.title}</h1>

      {fromSource && (
        <div
          style={{
            background: "#eef6ff",
            padding: "12px",
            marginBottom: "1rem"
          }}
        >
          <strong>
            {fromSource === "agi" ? t.fromAgi : t.fromVoice}
          </strong>
        </div>
      )}

      <textarea
        value={inputText}
        onChange={(e) => setInputText(e.target.value)}
        placeholder={t.placeholder}
        style={{ width: "100%", height: "180px", padding: "12px" }}
      />

      <div style={{ marginTop: "1rem" }}>
        <select
          value={style}
          onChange={(e) => setStyle(e.target.value)}
        >
          {["professional", "polite", "firm", "urgent"].map((s) => (
            <option key={s}>{s}</option>
          ))}
        </select>

        <button
          onClick={() => callRewriteAPI()}
          disabled={loading}
          style={{
            marginLeft: "10px",
            padding: "10px 20px",
            background: "#0d6efd",
            color: "white",
            border: "none",
            borderRadius: "6px",
            fontWeight: "bold",
            cursor: "pointer"
          }}
        >
          {loading ? t.working : t.btnRewrite}
        </button>
      </div>

      {errorMsg && <p style={{ color: "red" }}>{errorMsg}</p>}

      {getRightsTip() && (
        <div
          style={{
            background: "#fff4d2",
            padding: "10px",
            marginTop: "1rem"
          }}
        >
          <strong>{t.rightsTip}</strong> {getRightsTip()}
        </div>
      )}

      {isAboveGuideline && (
        <div
          style={{
            marginTop: "1rem",
            color: "#b45309",
            fontWeight: "600"
          }}
        >
          {t.agiWarning}
        </div>
      )}

      {rewritten && (
        <>
          <pre
            style={{
              marginTop: "2rem",
              whiteSpace: "pre-wrap",
              background: "#fff",
              padding: "20px",
              border: "1px solid #ddd"
            }}
          >
            {rewritten}
          </pre>

          {renderInfoRefs()}

          <button
            onClick={downloadAsPDF}
            style={{
              marginTop: "1.5rem",
              padding: "14px 28px",
              background: "#28a745",
              color: "white",
              border: "none",
              borderRadius: "6px",
              fontWeight: "bold",
              minWidth: "220px",
              cursor: "pointer"
            }}
          >
            üìÑ {t.download}
          </button>
        </>
      )}
    </div>
  );
}
